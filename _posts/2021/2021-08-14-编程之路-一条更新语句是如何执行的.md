---
layout:     post             				# 使用的布局（不需要改）
title:        MySQL系列：更新语句是如何执行的    # 标题 
subtitle:    					  				#副标题
date:       2021-10-05  					# 时间
author:     阿琦                  			# 作者
header-img: img/home-bg-o.jpg 	#这篇文章标题背景图片
catalog: true                        	# 是否归档
istop:  false                             # 是否置顶
iscopyright: true                      # 是否版权，默认有
music-id:                                        # 网易云音乐单曲嵌入
music-idfull:                               # 网易云音乐歌单嵌入
apserver:                           # 音乐平台netease/tencent/kugou/xiami/baidu
aptype:     	           		# 音乐类型song/playlist/album/search/artist
apsongid:                    # 音乐song/playlist/album id
tags:                              	           	#标签
    - 自我总结
    - DB
---

&nbsp;
&nbsp;

<section id="nice" data-tool="mdnice编辑器" data-website="https://www.mdnice.com" style="font-size: 16px; color: black; padding: 0 10px; line-height: 1.6; word-spacing: 0px; letter-spacing: 0px; word-break: break-word; word-wrap: break-word; text-align: left; font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, 'PingFang SC', Cambria, Cochin, Georgia, Times, 'Times New Roman', serif; counter-reset: counterh1 counterh2 counterh3;"><h2 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; font-size: 22px;"><span class="prefix" style="display: inline-block;"><span style="counter-increment: counterh2; color: rgb(159,205,208); border-bottom: 4px solid rgb(159,205,208); font-size: 18px; padding: 2px 4px;">1</span></span><span class="content" style="font-size: 18px; border-bottom: 4px solid rgb(37,132,181); padding: 2px 4px; color: rgb(37,132,181);">叨逼叨</span><span class="suffix"></span></h2>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">本文主要内容有：</p>
<ul data-tool="mdnice编辑器" style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: disc;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">redo log</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">bin log</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">WAL 技术</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">什么是crash-safe</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">两阶段提交</section></li></ul>
<h2 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; font-size: 22px;"><span class="prefix" style="display: inline-block;"><span style="counter-increment: counterh2; color: rgb(159,205,208); border-bottom: 4px solid rgb(159,205,208); font-size: 18px; padding: 2px 4px;">2</span></span><span class="content" style="font-size: 18px; border-bottom: 4px solid rgb(37,132,181); padding: 2px 4px; color: rgb(37,132,181);">一条SQL更新语句是如何执行的？</span><span class="suffix"></span></h2>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">上一篇：<a href="https://mp.weixin.qq.com/s/uVSWWLF1_JQSdPfPuvrJ9A" style="text-decoration: none; word-wrap: break-word; font-weight: bold; color: rgb(37,132,181); border-bottom: 1px solid rgb(37,132,181);">一条SQL查询语句是如何执行的</a></p>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">一条查询语句的流程一般经过连接器、分析器、优化器、执行器等模块，最终到达存储引擎。</p>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">那么问题来了，一条 sql 更新语句是怎么跑的？</p>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">以前可能听到大佬或者运维的同事说，MySQL 可以恢复到半个月内任意一秒的状态。</p>
<figure data-tool="mdnice编辑器" style="margin: 0; margin-top: 10px; margin-bottom: 10px; display: flex; flex-direction: column; justify-content: center; align-items: center;"><img src="https://tva1.sinaimg.cn/large/008i3skNly1gtg1hz80wkj60qi0pmtb202.jpg" alt style="display: block; margin: 0 auto; max-width: 100%;"></figure>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">先建一个表</p>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px; border-radius: 5px; box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block; background: url(https://files.mdnice.com/user/3441/876cad08-0422-409d-bb5a-08afec5da8ee.svg); height: 30px; width: 100%; background-size: 40px; background-repeat: no-repeat; background-color: #282c34; margin-bottom: -7px; border-radius: 5px; background-position: 10px 10px;"></span><code class="hljs" style="overflow-x: auto; padding: 16px; color: #abb2bf; display: -webkit-box; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; font-size: 12px; -webkit-overflow-scrolling: touch; padding-top: 15px; background: #282c34; border-radius: 5px;">mysql&gt;&nbsp;<span class="hljs-function" style="line-height: 26px;">create&nbsp;table&nbsp;<span class="hljs-title" style="color: #61aeee; line-height: 26px;">aaaqi_demo2</span><span class="hljs-params" style="line-height: 26px;">(id&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">int</span>&nbsp;primary&nbsp;key&nbsp;,c&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">int</span>)</span></span>;<br>Query&nbsp;OK,&nbsp;<span class="hljs-number" style="color: #d19a66; line-height: 26px;">0</span>&nbsp;<span class="hljs-function" style="line-height: 26px;">rows&nbsp;<span class="hljs-title" style="color: #61aeee; line-height: 26px;">affected</span>&nbsp;<span class="hljs-params" style="line-height: 26px;">(<span class="hljs-number" style="color: #d19a66; line-height: 26px;">0.03</span>&nbsp;sec)</span><br></span></code></pre>
<figure data-tool="mdnice编辑器" style="margin: 0; margin-top: 10px; margin-bottom: 10px; display: flex; flex-direction: column; justify-content: center; align-items: center;"><img src="https://tva1.sinaimg.cn/large/008i3skNly1gtdta556olj60no0b80tt02.jpg" alt style="display: block; margin: 0 auto; max-width: 100%;"></figure>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">如果将 id 为 2 的这条记录的 c 值更新为 4</p>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px; border-radius: 5px; box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block; background: url(https://files.mdnice.com/user/3441/876cad08-0422-409d-bb5a-08afec5da8ee.svg); height: 30px; width: 100%; background-size: 40px; background-repeat: no-repeat; background-color: #282c34; margin-bottom: -7px; border-radius: 5px; background-position: 10px 10px;"></span><code class="hljs" style="overflow-x: auto; padding: 16px; color: #abb2bf; display: -webkit-box; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; font-size: 12px; -webkit-overflow-scrolling: touch; padding-top: 15px; background: #282c34; border-radius: 5px;">mysql&gt;&nbsp;update&nbsp;aaaqi_demo2&nbsp;set&nbsp;c=<span class="hljs-number" style="color: #d19a66; line-height: 26px;">4</span>&nbsp;where&nbsp;id=<span class="hljs-number" style="color: #d19a66; line-height: 26px;">2</span>;<br>Query&nbsp;OK,&nbsp;<span class="hljs-number" style="color: #d19a66; line-height: 26px;">1</span>&nbsp;<span class="hljs-function" style="line-height: 26px;">row&nbsp;<span class="hljs-title" style="color: #61aeee; line-height: 26px;">affected</span>&nbsp;<span class="hljs-params" style="line-height: 26px;">(<span class="hljs-number" style="color: #d19a66; line-height: 26px;">0.01</span>&nbsp;sec)</span><br>Rows&nbsp;matched:&nbsp;1&nbsp;&nbsp;Changed:&nbsp;1&nbsp;&nbsp;Warnings:&nbsp;0<br></span></code></pre>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">之前查询语句的流程图如下，更新语句流程也是这样走的
<img src="https://tva1.sinaimg.cn/large/008i3skNly1gtg1ki9q9bj610e0pgwib02.jpg" alt style="display: block; margin: 0 auto; max-width: 100%;"></p>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">还是先连接数据库走连接器。</p>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">现在是更新操作，和这个表相关的查询缓存都会失效，这条语句会把 aaaqi_demo2 表上的所有缓存结果清空，这也是一般不建议使用查询缓存的原因。当然像什么配置表之类还是可以的。</p>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">接下来走到分析器，分析器会通过词法和语法分析知道这是一条更新语句，优化器会决定使用这个 id 的索引（其实这里优化器不一定使用你期望的索引，听大佬说内部还有个投票选举的机制，会使用票数多的那个索引，后面我会写个demo）。</p>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">然后执行器负责具体的执行，找到这一行，然后更新。</p>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">更新和查询不一样的地方在于，它还涉及两个重要的日志模块：<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; color: #1e6bb8; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all;">redo log(重做日志)</code>,<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; color: #1e6bb8; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all;">bin log(归档日志)</code>。 这个两个日志非常重要，MySQL 很多牛皮的功能都会用到。</p>
<h2 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; font-size: 22px;"><span class="prefix" style="display: inline-block;"><span style="counter-increment: counterh2; color: rgb(159,205,208); border-bottom: 4px solid rgb(159,205,208); font-size: 18px; padding: 2px 4px;">3</span></span><span class="content" style="font-size: 18px; border-bottom: 4px solid rgb(37,132,181); padding: 2px 4px; color: rgb(37,132,181);">重要的日志模块 redo log</span><span class="suffix"></span></h2>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">这个日志的话，MySQL 有两种做法：</p>
<ol data-tool="mdnice编辑器" style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: decimal;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">先把记录写到 redo log 里面，等系统空闲的时候再更新到磁盘里面去。</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">每次的更新操作都需要写进磁盘，然后磁盘也要找到对应的那条记录，然后更新。</section></li></ol>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">但是第2种做法会导致整个过程IO成本、查找成本都会很高。</p>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">为了解决这个问题，MySQL设计者用磁盘和rode log进行配合，这个过程就是 MySQL 里面常说的<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; color: #1e6bb8; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all;">WAL 技术</code>，WAL 的全称是“Write-Ahead Logging”，<u>它的关键点就是先写日志，再写磁盘。</u></p>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">详细点就是说当有一条记录需要更新的时候，Innodb引擎就会先把记录写到redo log里面，并更新内存，这个时候更新就算完成了。同时，Innodb 引擎会在适当的时候把这个操作记录更新到磁盘里面，而这个更新一般会在系统比较空闲的时候去做。</p>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">另外，Innodb的 redo log是固定大小的，比如一组可以配置4 个文件，每个文件大小是 1GB，那么总共就可以记录 4GB 的操作。从头开始写，写到末尾又回到开头循环写，如下图：
<img src="https://tva1.sinaimg.cn/large/008i3skNly1gtg1l0djt0j60fc0ce75c02.jpg" alt style="display: block; margin: 0 auto; max-width: 100%;"></p>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">write pos 是当前记录位置，一边写一边顺时针向后移动，写到 3 号文件末尾就回到 0 号文件开头。checkpoint 是当前要擦除的位置，也是顺时针往后移动并且循环的，擦除记录前要把记录更新到数据文件。</p>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">write pos 和 checkpoint 之间空着的部分用来记录新的操作。如果 write pos 追上 checkpoint 那么表示redo log 满了，这时候不能再执行更新操作，得先停下来擦掉一些记录，把 checkpoint推进一些。</p>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">有了 redo log，Innodb就可以保证即使数据库发生异常重启，之前提交的记录都不会丢失，这个能力称为<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; color: #1e6bb8; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all;">crash-safe</code>。</p>
<h2 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; font-size: 22px;"><span class="prefix" style="display: inline-block;"><span style="counter-increment: counterh2; color: rgb(159,205,208); border-bottom: 4px solid rgb(159,205,208); font-size: 18px; padding: 2px 4px;">4</span></span><span class="content" style="font-size: 18px; border-bottom: 4px solid rgb(37,132,181); padding: 2px 4px; color: rgb(37,132,181);">重要日志模块 binlog</span><span class="suffix"></span></h2>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">MySQL 整体来看分为两块，一块是server 层，一块是引擎层。server层主要做 MySQL 功能方面的事情；引擎层主要负责存储相关事宜。redo log 是Innodb引擎特有的日志，binlog 是 server 层的日志。</p>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">最开始MySQL并没有Innodb引擎，默认是 MyISAM，但是 MyISAM 没有crash-safe的能力，binlog 只能用于归档。而Innodb是另一个公司以插件的形式引入 MySQL 的，只依靠 binlog 是没有 crash-safe 能力的，所以Innodb使用 redo-log 来实现crash-safe 能力。</p>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">redo-log、binlog 有几点不同：</p>
<ol data-tool="mdnice编辑器" style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: decimal;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">redo log 是Innodb引擎特有的；binlog 是MySQL server 层实现的，所有引擎都能使用。</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">redo log 是物理日志，记录的是在某数据页上做了什么修改；binlog 是逻辑日志，记录的是这个语句的原始逻辑，比如：给 id 为 2 的这条数据c 字段更新为4。</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">redo log 是循环写，固定空间会用完；binlog 是追加写入的。“追加写”是指binlog 文件写到一定大小后会切换到下一个，并不会覆盖以前的日志。</section></li></ol>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">通过上面了解后，再看 Innodb 引擎执行之前简单的 update 语句时，MySQL 内部是怎么走的。</p>
<ol data-tool="mdnice编辑器" style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: decimal;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;"><p style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">执行器先找引擎取id=2 这行。id 是主键，引擎直接用树搜索找到这一行。如果 id=2这行数据本来就在数据页中的话，就直接返回给执行器；否则先要从磁盘读入内存，然后再返回。</p>
</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;"><p style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">执行器拿到引擎给的行数据，原来是 2，现在更新为 4，得到新的一行数据，再调用引擎接口写入这行新数据。</p>
</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;"><p style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">引擎将这行新数据更新到内存中，同时将这个更新操作记录到 redo log 里面，此时 redo log 处于prepare 状态。告知执行器执行完了，可以随时提交事务。</p>
</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;"><p style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">执行器生成这个操作的 binlog，并把binlog 写入磁盘。</p>
</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;"><p style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">执行器调用引擎的提交事务接口，引擎把刚刚写入的 redo log改成 commit 状态，更新完成。</p>
</section></li></ol>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">下面是执行流程图：</p>
<figure data-tool="mdnice编辑器" style="margin: 0; margin-top: 10px; margin-bottom: 10px; display: flex; flex-direction: column; justify-content: center; align-items: center;"><img src="https://tva1.sinaimg.cn/large/008i3skNly1gtg1j57zuuj60gi0z0jvl02.jpg" alt style="display: block; margin: 0 auto; max-width: 100%;"></figure>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">注意到最后三步了吧，将 redo log的写入拆成两个步骤：prepare 和 commit 这就是<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; color: #1e6bb8; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all;">二阶段提交</code>。</p>
<h2 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; font-size: 22px;"><span class="prefix" style="display: inline-block;"><span style="counter-increment: counterh2; color: rgb(159,205,208); border-bottom: 4px solid rgb(159,205,208); font-size: 18px; padding: 2px 4px;">5</span></span><span class="content" style="font-size: 18px; border-bottom: 4px solid rgb(37,132,181); padding: 2px 4px; color: rgb(37,132,181);">二阶段提交</span><span class="suffix"></span></h2>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;"><strong style="font-weight: bold; color: rgb(37,132,181);">怎样让数据库恢复到半个月内任意一秒的状态？</strong> 来说二阶段提交。</p>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">前面提到过 binlog会记录所有逻辑操作，并采用“追加写”的形式。如果运维说一个月内可以恢复，那么备份系统中一定会保存最近一个月的所有 binlog，同时系统还会定期做整库备份。</p>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">当需要恢复到某一秒时，比如某天下午两点发现中午十二点有一次误删表，需要找回数据（如果是用的阿里的 MySQL，直接到那个后台管理，是可以直接恢复的），那么可以这样做：</p>
<ul data-tool="mdnice编辑器" style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: disc;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;"><p style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">首先找到最近的一次全量备份，如果你运气好，可能就是昨晚的一个备份，从这个备份恢复到临时库；</p>
</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;"><p style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">然后，从备份的时间点开始，将备份的binlog一次取出来，重放到中午误删表之前的那个时刻。</p>
</section></li></ul>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">现在临时库就和之前误删之前一样了，然后把表数据从临时库中取出按需恢复到线上库。</p>
<h2 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; font-size: 22px;"><span class="prefix" style="display: inline-block;"><span style="counter-increment: counterh2; color: rgb(159,205,208); border-bottom: 4px solid rgb(159,205,208); font-size: 18px; padding: 2px 4px;">6</span></span><span class="content" style="font-size: 18px; border-bottom: 4px solid rgb(37,132,181); padding: 2px 4px; color: rgb(37,132,181);">反证法 日志为什么需要二阶段提交</span><span class="suffix"></span></h2>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">由于redo log 和binlog是两个独立的逻辑，如果不用两阶段提交，要么就是先写 binlog再写 redo log，或者反过来写。会出现什么问题。</p>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">前面写的 update 举例，假设 id=2 的这条数据，字段 c=0，再假设执行 update语句中执行完第一个日志后，第二个日志还没写完，期间发生了crash，会出现什么情况？</p>
<ul data-tool="mdnice编辑器" style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: disc;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;"><code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; color: #1e6bb8; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all;">先写 redo log后写 binlog</code>。如果在 redo log 写完，binlog 还没写完时，MySQL进程异常死掉了重启。前面提到 redo log 写完后，系统即使挂了，仍然能够把数据恢复回来，所以恢复这行数据c 的值是 1。</section></li></ul>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">由于binlog 没写完就crash 了，这时binlog 里面没有记录上这个语句。因此，后面备份日志的时候，存起来的 binlog里就没有这条语句。</p>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">然后你就会发现，如果用这个 binlog 恢复临时库的话，由于这个语句的 binlog 丢失，临时库就少了这次更新，恢复出来的这行数据 c 值等于 0和原库的值不同。</p>
<ul data-tool="mdnice编辑器" style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: disc;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;"><code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; color: #1e6bb8; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all;">先写 binlog 后写 redo log</code>。如果在 binlog 写完后 crash，由于redo log 么写完，崩溃恢复以后这个事务无效，所以这行 c=0。但 binlog里已经记录了把“c 从 2改成 4”这个日志。所以 binlog 恢复出来就会多出一个事务，恢复出的这一行c 的值是 4，与原库的 c 值不同。</section></li></ul>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">上面可以看到，如果不使用二阶段提交，那么数据库的状态就有可能和它通过日志恢复的临时库的状态不一致。</p>
<h2 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; font-size: 22px;"><span class="prefix" style="display: inline-block;"><span style="counter-increment: counterh2; color: rgb(159,205,208); border-bottom: 4px solid rgb(159,205,208); font-size: 18px; padding: 2px 4px;">7</span></span><span class="content" style="font-size: 18px; border-bottom: 4px solid rgb(37,132,181); padding: 2px 4px; color: rgb(37,132,181);">相关配置</span><span class="suffix"></span></h2>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">MySQL 里面最重要的两个日志，即物理日志 redo log 和逻辑日志 binlog。</p>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">redo log 用于保证 crash-safe 能力。<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; color: #1e6bb8; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all;">innodb_flush_log_at_trx_commit</code> 这个参数设置成 1 时，表示每次事务的 redo log 都直接持久化到磁盘。线上库建议设置成 1，这样可以保证 MySQL 异常重启之后数据不丢失。</p>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;"><code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; color: #1e6bb8; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all;">sync_binlog</code> 这个参数设置成 1 的时候，表示每次事务的 binlog 都持久化到磁盘。线上库这个参数也建议设置成 1，这样可以保证 MySQL 异常重启之后 binlog 不丢失。</p>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">不过我这个版本默认都是开启的，其它版本不清楚：</p>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px; border-radius: 5px; box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block; background: url(https://files.mdnice.com/user/3441/876cad08-0422-409d-bb5a-08afec5da8ee.svg); height: 30px; width: 100%; background-size: 40px; background-repeat: no-repeat; background-color: #282c34; margin-bottom: -7px; border-radius: 5px; background-position: 10px 10px;"></span><code class="hljs" style="overflow-x: auto; padding: 16px; color: #abb2bf; display: -webkit-box; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; font-size: 12px; -webkit-overflow-scrolling: touch; padding-top: 15px; background: #282c34; border-radius: 5px;">mysql&gt;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">SHOW</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">VARIABLES</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">LIKE</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">'innodb_flush_log_at_trx_commit'</span>;<br></code></pre>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px; border-radius: 5px; box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block; background: url(https://files.mdnice.com/user/3441/876cad08-0422-409d-bb5a-08afec5da8ee.svg); height: 30px; width: 100%; background-size: 40px; background-repeat: no-repeat; background-color: #282c34; margin-bottom: -7px; border-radius: 5px; background-position: 10px 10px;"></span><code class="hljs" style="overflow-x: auto; padding: 16px; color: #abb2bf; display: -webkit-box; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; font-size: 12px; -webkit-overflow-scrolling: touch; padding-top: 15px; background: #282c34; border-radius: 5px;">mysql&gt;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">SHOW</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">VARIABLES</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">LIKE</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">'sync_binlog'</span>;<br></code></pre>
<figure data-tool="mdnice编辑器" style="margin: 0; margin-top: 10px; margin-bottom: 10px; display: flex; flex-direction: column; justify-content: center; align-items: center;"><img src="https://tva1.sinaimg.cn/large/008i3skNly1gte5ty6r4zj610b0u0dkw02.jpg" alt style="display: block; margin: 0 auto; max-width: 100%;"></figure>
<figure data-tool="mdnice编辑器" style="margin: 0; margin-top: 10px; margin-bottom: 10px; display: flex; flex-direction: column; justify-content: center; align-items: center;"><img src="https://tva1.sinaimg.cn/large/008i3skNly1gtg1da276sg60hs09wnpg02.gif" alt style="display: block; margin: 0 auto; max-width: 100%;"></figure>
</section>